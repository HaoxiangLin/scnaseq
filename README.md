# sCNA-seq

##Introduction
sCNA-Seq is a light weight java tool, designed to estimate copy number changes through the analysis of NGS data from a cfDNA sample and a single reference sample.

###Prerequisites
Java 1.6 or higher


###Optional Prerequisites
R 3.2.1 (for GC correction)

###Installing
1. Prepare machine for install
	1.a. Install JAVA
	1.b. Install MAVEN

2. Install sCNA-Seq
	sh install.sh

3. Set up directory structure
	The following directory structure needs to be in place in order for sCNA-seq to run:
	/sCNA-Seq/
	/sCNA-Seq/data/
	/sCNA-Seq/analysis/

##Running sCNA-Seq

###Generate counts file
sCNA-Seq requires a counts file. This file can be generated from a range of tools. All the work presented in Robertson. et al (2018), was carried out using a counts file produced by qCNV[https://sourceforge.net/p/adamajava/wiki/qCnv/]. Any counts file will work as long as the data is provided in the following format:

		#CHROM	ID	START	END	FORMAT	cfDNA	NORMAL
		chr1	1_1000	1	1000	DP	601	286
		chr1	2_1000	1001	2000	DP	548	295
		chr1	3_1000	2001	3000	DP	534	289

		Note the counts file must have the column names as the samples

The window size used in development was 1000 bp, however sCNA-Seq can handle windows of any size.  It is important to pay attention to this attribute, as smaller windows increases the time and computational resources needed in downstream analyses, whihc use integers of this window size to detect sCNAs.

sCNA-Seq requires the data to be named and stored in the following structure:
	/sCNA-Seq/data/experiment.counts 

###Optional - GC correction

If GC correction is required, it is possible to do so at this point. We read counts file generated by qCNV into R and use the contained script to correct the counts file for GC biases. 

##run.sh

This script contains the commands needed to generate the specific parameter files, set the required mode of sCNA-seq and run the tool. This scipt can be run as:
	sh run.sh


###  Preparation of parameter files
There are a large number of variables used by sCNA-Seq. These variables are stored in 3 places data3.csv, param.txt and the command line. Of these 3 places the command line has the highest priority. Despite this, both the csv file and the txt file need to be correctly formatted for the tool to run.

These files can easily be produced using the following the commands and ‘template’ files:
	sed 's/XXXX_XXXX/'$NAME'/g' GENERIC_DATA3.csv > data3.csv
	sed 's/XXXX_XXXX/'$NAME'/g' GENERIC_PARAM07.txt > param.txt

	Note: Here $NAME refers to the name of the experiment, a consistent variable needed

Both these files need to be stored in: 
	/sCNA-Seq/analysis/ 

This function is carried out automatically by run.sh

### Modes
The number of parameters used by sCNA-seq makes the tool very versatile. Using different combinations of set parameters we were able to develop a set of specific modes.  The parameters altered in each of these modes are defined on the command line.

Preparation – defining ploidy
sCNA-seq is unable to define the base-line ploidy of a sample denovo. However it is able to use existing information about the ploidy of a sample in the analysis of sCNA. 

The default ploidy value used by sCNA-seq is 2. When ploidy is incorrectly assigned it can produce a copy number profile that does not reflect the sCNAs in a tumour genome. To identify these instances, we have produced a perl script that examines the results produced by sCNA-seq and produces a warning if too many sCNAs are identified. If this warning is produced, we suggest re-running sCNA-seq but assuming that your cfDNA sample is a triploid or a tetra-ploid. 

Ploidy is set by the BC value 

BC=2	#Diploid
BC=2	#Triploid
BC=2	#Tetraploid

(NOTE: there is a known bug in the tetraploid analysis that causes some plots to incorrectly display the colour of a sCNA in the tetraploid plots. Despite this the txt file results are correct.)


####Mode 1: Whole Genome Training Mode.
This mode was developed to allow sCNA-seq to more accurately determine the proportion of tumour content in a sample. It uses larger segments and a smaller number of copy number states to iteratively estimate the level of tumour content in a cfDNA sample. These attributes reduce the complexity of the model, and allows sCNA-seq to provide more accurate estimates of tumour content in a wider-range of scenarios. 

MODE1: Parameters
        cumR=250			#number of qCNV windows used to make a sCNA-seq segment 
					#sCNA-seq segment = qCNV window x cumR = 250 x 1000bp windows
        MAXCN=2				#number of copy number states (2 x base-line ploidy)
        train=2				#determine the proportion of tumour content in a sample
        AVERAGE_DEPTH="false"		#needed for training mode
        MAKE_NEW_REF="false"		#needed for training mode
        plot=1				#plot the data
        CellRatio="0.9999999:1.0"
        RANGE="all:1,0mb:X,300mb"	#analyse whole genome
        RANGE1="1_0mb_X_300mb"
        BDW="10" 			#beta-down weight – sensitivity(reduces number of breakpoints)
        NumberIT=25			#number of iterations


####Mode 2: Genome Wide Survey 
This mode uses the CELL and the RATIO values calculated in the first mode to profile the genome. This information allows this mode to process the counts file using a more complex model (i.e. with smaller segments, and a larger number of copy number states). Because this model doesn’t need to determine the proportion of tumour content in the sample it doesn’t need to be run iteratively, and finishes in a significantly shorter amount of time than Mode 1, despite using a more complex model. 

MODE2: Parameters
CELL=”user_defined”			#CELL value from MODE1
RATIO=”user_defined”			#RATIO value from MODE1
        cumR=100			#user defined – dependent on data-set
        MAXCN=5				#number of copy number states (5 x base-line ploidy)
        train=0				#do not train model
        AVERAGE_DEPTH="true"		#adjusted for no training
        MAKE_NEW_REF="false"		#needed for training mode
        plot=1				#plot the data
        CellRatio="${CELL}:${RATIO}"
        RANGE="all:1,0mb:X,300mb"	#analyse whole genome
        RANGE1="1_0mb_X_300mb"
        BDW="10" 			#beta-down weight – sensitivity(reduces number of breakpoints)
        NumberIT=1			#number of iterations


####Mode 3: High resolution regional analysis mode
This mode continues to use the CELL and RATIO values determined in mode 1 to provide an ultra-high resolution map of a specific region of the genome. This mode makes use of very small segments. The smallest a sCNA-seq segment can be is 2 (or two windows from qCNV). This mode requires you enter the chromosome(s), you’d like to examine (need to be in ascending order), as well as the location of the region in Mb. For example if you would like to examine KRAS, then you would enter:
CHR_FROM=”12”
START=”25.0”
CHR_TO=”12”
END=”25.5”
This would provide a high resolution map of the 500 kb on chromosome 12 between 25 Mb and 25.5 Mb. This mode uses a lower BDW, a value which can be adjusted to increase sCNA-seq ability to define break points between segments with closely related sCNAs.

MODE3: Parameters
	CELL=”user_defined”	#CELL value from MODE1
	RATIO=”user_defined”	#RATIO value from MODE1
	CellRatio="${CELL}:${RATIO}"

	CHR_FROM="12"
	START="9.5"
	CHR_TO="12"
	END="10"
	RANGE="all:${CHR_FROM},${START}mb:${CHR_TO},${END}mb"
	RANGE1="${CHR_FROM}""_${START}mb""_${CHR_TO}""_${END}mb"

	cumR=5				#user defined – minimum 2 
	MAXCN=5				#number of copy number states (5 x base-line ploidy)
	train=0				#do not train model
	AVERAGE_DEPTH="true"		#adjusted for no training
	MAKE_NEW_REF="false"		#needed for training mode
	plot=1				#plot the data
	BDW="1" 			#beta-down weight – sensitivity(reduces number of breakpoints)
	NumberIT=1			#number of iterations

###Running sCNA-Seq
1.	sCNA-seq can only be run from the specific directory “/sCNA-Seq/analysis/ “. We run sCNA-Seq by changing to this directory with the following command
cd /sCNA-Seq/analysis/ 

2.	We then define location of the sCNA-seq library with:
LIB=/panfs/home/arobertson/PlasmaCNV_0.74/lib

3.	We then define the version of java used for this analysis 
mkdir ~/7_HitSeq/AUG_OUT/$NAME/analysis/java
cp -r /panfs/home/arobertson/CNV/jre1.6.0_19/ ~/7_HitSeq/AUG_OUT/$NAME/analysis/java
java=/panfs/home/arobertson/7_HitSeq/AUG_OUT/$NAME/analysis/java/jre1.6.0_19/bin/java

4.	To ensure that multiple sCNA-seq analyses can be processed at once we move this onto a node
mkdir /tmp/minion_sCNAHitSeq    #Make temp directory
cp -r ~/7_HitSeq/AUG_OUT/$NAME/ /tmp/minion_sCNAHitSeq/
cd /tmp/minion_sCNAHitSeq/$NAME/analysis/

5.	We then define the sCNA-seq sampleID, the base directory and define memory needed to run the tool
sampleid="$NAME"
baseDir="/tmp/minion_sCNAHitSeq/$NAME/data/"
mem=46900m
dat=$(date +%m%d%H%M%S)

6.	We then prepare the CLASS for this job
ls $LIB>lib_list_$dat
while read line; do
class=$class:"$LIB/$line"
done < lib_list_$dat
rm lib_list_$dat

7.	Finally we define all the variables on the command line
line="${java} -Xmx${mem} -server -cp ${class} lc1.dp.appl.CNVHap --paramFile  param.txt --index 1 --column 1 --baseDir ${baseDir}   --numIt ${NumberIT} --plot ${plot} --showScatter false  --r_panel true  --b_panel true  --showHMM false --showHaps false  --restrictKb 0kb:0kb --include ${NAME} --experiment ${NAME}.${MODE}.${cumR}.${dat} --initialCellularity ${CellRatio} --downsample 1:1 --dilute 1:0 --cumulativeR ${cumR}  --useAvgDepth ${AVERAGE_DEPTH} --makeNewRef ${MAKE_NEW_REF} --maxPloidy1 1 --noCopies ${ploidy} --backgroundCount ${ploidy} --ratioAsLevels null --trainCellularity ${train} --reference ${REF_ID} --betaDownWeight ${BDW} --noSampleFromBeta ${BETA} --minNormalDepth 10 --mid ${RANGE} --backgroundCount1 ${BC} --numThreads ${THREADS} --alleles 1 --globalTrans false --trainTransitions false --maxCN ${MAXCN} --modify0 null --plotCNAsShape false --r_panel_width 2000 --inputDirLoc ${NAME}.counts --chroms $CHROMS  --toInclude $REF_ID;$TUM_ID --color $COLOUR --includeLegend false --minB 0 --maxR 3"

8.	sCNA-seq is then run with the following command:
$line

9.	Once sCNA-seq is completed the results file is passed through a QC script. This checks if the experiment was successful and translates the HMM CN states into a more user friendly format. It produces two files: one containing a summary of the results, and another with the sCNA with human friendly copy number states. These files can be found in:

#define variables
ONE=`pwd`
FOUR_LOC=`echo $ONE`
TWO=`ls | grep $NAME`
THREE_NAME=`echo $TWO`


echo "starting QC summary script"
perl NEW_PRODUCTION.pl $FOUR_LOC $THREE_NAME $cumR $NAME $MODE $RANGE1 $BDW $BC $TUM_BAM $REF_BAM ${GC_CORRECTION}

This script produces two files: one containing a summary of the results, and another with the sCNA with human friendly copy number states. These files can be found in:
/sCNA-Seq/analysis/[EXPERIMENT_NAME]/cnv/[

10.	Optional - Running Mode 2 / Mode 2. In order to run Mode 2 or Mode 3 - the amount of tumour content defined by the first mode of sCNA-seq is required. To achieve this the CELL and RATIO values are taken from either of the edited results files from the QC script 
/sCNA-Seq/analysis/[EXPERIMENT_NAME]/cnv/[EXPERIMENT_NAME]_EDITED_CNV.txt
/sCNA-Seq/analysis/[EXPERIMENT_NAME]/cnv/[EXPERIMENT_NAME]_SUMMARY.txt


